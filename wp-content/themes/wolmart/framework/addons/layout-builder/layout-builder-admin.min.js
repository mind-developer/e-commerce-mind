"use strict";window.WolmartAdmin=window.WolmartAdmin||{},function(t){var o={init:function(){for(var t in this.conditions=JSON.parse(JSON.stringify(wolmart_layout_vars.conditions))||{},this.schemes=wolmart_layout_vars.schemes||{},this.clipboard=!1,this.controls=[],wolmart_layout_vars.controls)if(!t.startsWith("content"))for(var o in wolmart_layout_vars.controls[t])this.controls.push(o)},getConditions:function(t="",o=-1){return t?(this.conditions[t]||(this.conditions[t]=[]),o>=0&&this.conditions[t][o]?this.conditions[t][o]:this.conditions[t]):this.conditions},getOptionValues:function(t,o){return!(!this.conditions[t]||!this.conditions[t][o])&&this.conditions[t][o].options},getConditionTitle:function(t,o){return t&&this.schemes[t]?o?this.schemes[t].layout_title:this.schemes[t].title:""},setConditionTitle:function(t,o,e){this.conditions[t][o]&&(this.conditions[t][o].title=e),this.requireSave()},getScheme:function(t,o=""){return o?this.schemes[t].scheme[o]:this.schemes[t].scheme},getOptionControls:function(t){return!!wolmart_layout_vars.controls[t]&&wolmart_layout_vars.controls[t]},getTemplates:function(t){return wolmart_layout_vars.templates[t]},canExtendCondition:function(t,o=""){return!!(t&&this.schemes[t]&&this.schemes[t].scheme)&&(!o||this.schemes[t].scheme[o]&&this.schemes[t].scheme[o].list)},updateCategoryUI:function(o=""){var e=function(o){var e=t(".wolmart-condition-cat-"+o+"> .wolmart-condition-count"),i=this.conditions[o].filter((function(t){return t})).length;e.text(i),i?e.slideDown():e.slideUp()}.bind(this);o&&e(o);var i=0;for(var a in this.conditions)i+=this.conditions[a].filter((function(t){return t})).length,o||e(a);t(".wolmart-condition-cat-site > .wolmart-condition-count").text(i).slideDown()},addCondition:function(t){this.conditions[t]||(this.conditions[t]=[]);var o={};return o.title=this.getConditionTitle(t,!0)+" "+(this.conditions[t].length+1),o.scheme={},this.schemes[t].scheme&&this.schemes[t].scheme.all&&(o.scheme.all=!0),this.conditions[t].push(o),this.updateCategoryUI(t),this.requireSave(),this.conditions[t].length-1},deleteCondition:function(o,e){void 0!==this.conditions[o][e]&&(this.conditions[o].splice(e,1),t(".wolmart-layout-item[data-category="+o+"]").each((function(){var o=this.getAttribute("data-condition-no");o>e&&(this.setAttribute("data-condition-no",o-1),t(this).data("condition-no",o-1))})),t("#wolmart_layout_content").isotope("updateSortData").isotope()),this.updateCategoryUI(o),this.requireSave()},duplicateCondition:function(o,e){if(o&&"number"==typeof e&&this.conditions[o][e]){var i=JSON.parse(JSON.stringify(this.conditions[o][e]));return t(".wolmart-layout-item[data-category="+o+"]").each((function(){var o=this.getAttribute("data-condition-no");o>e&&(this.setAttribute("data-condition-no",1*o+1),t(this).data("condition-no",1*o+1))})),this.conditions[o].splice(e,0,i),this.updateCategoryUI(o),this.requireSave(),e+1}},copyOptions:function(t,o){this.clipboard={category:t,options:this.getOptionValues(t,o)}},pasteOptions:function(t,o,i){if(this.clipboard){if(t==this.clipboard.category)this.conditions[t][o]?this.conditions[t][o].options=this.clipboard.options:this.conditions[t][o]={options:this.clipboard.options};else{if(this.conditions[t][o].options)for(var a in this.conditions[t][o].options)this.controls.indexOf(a)&&delete this.conditions[t][o].options[a];else this.conditions[t][o].options={};for(var a in this.clipboard.options)this.controls.indexOf(a)&&(this.conditions[t][o].options[a]=this.clipboard.options[a])}e.refreshLayoutStatus(i),this.requireSave()}},requireSave:function(){t(".wolmart-layouts-save").addClass("require-save")},setConditionScheme:function(t,o,e,i){if(void 0===this.conditions[t][o])(a={})[e]=i,a.all=!0,this.conditions[t][o]={scheme:a};else if(this.conditions[t][o]){var a;if(!this.conditions[t][o].scheme)(a={})[e]=i,this.conditions[t][o].scheme=a;i?this.conditions[t][o].scheme[e]=i:delete this.conditions[t][o].scheme[e]}this.requireSave()},setConditionList:function(t,o,e,i){this.conditions[t][o]=i?{type:e,list:i}:{type:e},this.requireSave()},setConditionOption:function(t,o,e,i){this.conditions[t][o].options||(this.conditions[t][o].options={}),i?this.conditions[t][o].options[e]=i:delete this.conditions[t][o].options[e],this.requireSave()},save:function(){t(".wolmart-layouts-save").removeClass("require-save"),t.post(wolmart_core_vars.ajax_url,{action:"wolmart_layout_builder_save",nonce:wolmart_core_vars.nonce,conditions:this.conditions},(function(){})).fail((function(){t(".wolmart-layouts-save").addClass("require-save"),t(".wolmart-modal-message").remove(),t(".wolmart-layouts-save").before('<span class="wolmart-modal-message"></span>')}))}},e={init:function(){this.buttonDelete='<button class="wolmart-condition-button wolmart-condition-delete far fa-trash-alt"></button>',this.buttonDuplicate='<button class="wolmart-condition-button wolmart-condition-duplicate far fa-clone"></button>',this.buttonSet='<button class="wolmart-condition-button wolmart-condition-set fa fa-cog"></button>',this.layoutBoxTemplate=t("#wolmart_layout_template").text(),t("#wolmart_layout_template").remove(),t(document.body).on("click",".wolmart-layouts-save",this.onSave).on("contextmenu",".wolmart-layout-item",this.onContextMenu.bind(this)).on("click","#wolmart_layout_content",this.closeContextMenu).on("click",".wolmart-condition-menu > a",this.clickContextMenuItem).on("click",".wolmart-condition-copy",this.copyOptions).on("click",".wolmart-condition-paste",this.pasteOptions).on("click",".wolmart-condition-edit-back",this.goBackFromEdit).on("click",".wolmart-condition-cat",this.clickCategory.bind(this)).on("click",".wolmart-layout-more",this.addCondition.bind(this)).on("click",".wolmart-condition-delete",this.deleteCondition.bind(this)).on("click",".wolmart-condition-duplicate",this.duplicateCondition.bind(this)).on("change",".wolmart-scheme-options > div > label input[type=checkbox]",this.changeConditionScheme.bind(this)).on("change",".wolmart-scheme-list",this.changeConditionItem.bind(this)).on("input",".wolmart-condition-title",this.changeConditionTitle.bind(this)).on("click",".wolmart-layout .layout-part",this.editPart).on("click",".wolmart-condition-set",this.editCondition).on("click",this.clickOther.bind(this)).on("change",".wolmart-block-select input",this.changeBlockMode.bind(this)).on("change",".wolmart-layout-options input",this.changeOptionInput.bind(this)).on("change",".wolmart-layout-options select",this.changeOptionInput.bind(this)),this.setupLayouts()},refreshUI:function(o){o&&"layout"!=o&&"add"!=o||t("#wolmart_layout_content").isotope(),o&&"add"!=o||this.refreshLayoutStatus()},refreshLayoutStatus:function(e){e||(e=t("#wolmart_layout_content")),e.is(".wolmart-layout-item")||(e=e.find(".wolmart-layout-item")),e.each((function(){var e=t(this),i=e.data("category"),a=e.data("conditionNo"),n=o.getOptionValues(i,a);if(n)for(var s in wolmart_layout_vars.controls)if(o.controls.indexOf(s)){var l=o.getOptionControls(s),r=e.find('.layout-part[data-part="'+s+'"]'),c=!1;for(var d in r.removeClass("set hide"),r.children(".block-value").text(""),l)if(n[d]){c=!0;break}if(l[s]&&"hide"==n[s])r.addClass("hide");else if(c&&(r.addClass("set"),l[s])){var u=o.getTemplates(l[s].type.replace("block_",""));u&&u[n[s]]&&r.children(".block-value").text(u[n[s]])}}}))},setupLayouts:function(){var e="",i=o.schemes;if(i){for(var a in i){var n=o.getConditions(a);for(var s in n)e+=this.getNewConditionUI(a,s);"site"==a||!o.canExtendCondition(a)&&n.length||(e+=this.getAddMoreUI(a))}t("#wolmart_layout_content").html(e).isotope({layoutMode:"fitRows",filter:".wolmart-layout-item",sortBy:["category","no"],getSortData:{category:function(t){var e=t.getAttribute("data-category");return Object.keys(o.schemes).indexOf(e)},no:function(t){return parseInt(t.getAttribute("data-condition-no"))}}}),o.updateCategoryUI(),this.refreshUI()}},refreshCondition:function(o,e){var i=".wolmart-layout-item",a=this;o&&(i+='[data-category="'+o+'"]'),e&&(i+='[data-condition-no="'+e+'"]'),t(i).each((function(){a.editPart({currentTarget:t(this).find(".layout-part.active").get(0)})}))},onSave:function(){o.save()},onContextMenu:function(e){this.closeContextMenu();var i=t(e.currentTarget),a=t(".wolmart-admin-panel-content"),n=a.get(0).getBoundingClientRect(),s=i.data("category"),l='<div class="wolmart-condition-menu" style="left:'+(e.clientX-n.x+a.scrollLeft())+"px;top:"+(e.clientY-n.y+a.scrollTop())+'px;">',r='<a href="#" class="wolmart-condition-';l+=r+'copy"><i class="far fa-copy"></i>'+wolmart_layout_vars.text_copy+"</a>",o.clipboard&&(l+=r+'paste"><i class="fa fa-paste"></i>'+wolmart_layout_vars.text_paste+"</a>"),o.canExtendCondition(s)&&(l+=r+'duplicate"><i class="far fa-clone"></i>'+wolmart_layout_vars.text_duplicate+"</a>"),l+=r+'set"><i class="fa fa-cog"></i>'+wolmart_layout_vars.text_options+"</a>",l+=r+'delete"><i class="far fa-trash-alt"></i>'+wolmart_layout_vars.text_delete+"</a>",l+="</div>",a.append(l),t(".wolmart-condition-menu").data("item",i),e.preventDefault()},closeContextMenu:function(){t(".wolmart-condition-menu").remove()},clickContextMenuItem:function(t){t.preventDefault()},copyOptions:function(e){var i=t(e.currentTarget).parent().data("item");o.copyOptions(i.data("category"),i.data("condition-no"))},pasteOptions:function(e){var i=t(e.currentTarget).parent().data("item");o.pasteOptions(i.data("category"),i.data("condition-no"),i)},clickCategory:function(o){var e=t(o.currentTarget).addClass("active"),i=e.data("category");e.siblings(".active").removeClass("active"),t("#wolmart_layout_content").isotope({filter:"site"==i?".wolmart-layout-item":'[data-category="'+i+'"]'})},getAddMoreUI:function(t){return'<div class="wolmart-layout-more-wrap" data-category="'+t+'" data-condition-no="999"><div class="wolmart-layout-more"><div class="wolmart-layout-more-inner"><i class="wolmart-icon-plus"></i>'+wolmart_layout_vars.text_create_layout+"<b>"+o.getConditionTitle(t)+"</b></div></div></div>"},getNewConditionUI:function(t,e=-1){-1==e&&(e=o.addCondition(t));var i=o.getConditions(t,e);if(i){var a="";if(o.canExtendCondition(t)){var n,s=o.getScheme(t),l=i.scheme||{};for(var r in a+='<div class="wolmart-scheme-options"><label class="apply-text">'+wolmart_layout_vars.text_apply_prefix+o.getConditionTitle(t,!0).toLowerCase()+wolmart_layout_vars.text_apply_suffix+"</label>",s){n="wolmart-scheme-"+r,l&&l.all&&"all"==r||l[r]||(n+=" disabled"),a+='<div class="'+n+'" data-scheme="'+r+'">',a+='<label><input type="checkbox"'+(l[r]?" checked":"")+">"+s[r].title+"</label>";var c=s[r].list;if(c){for(var d in a+='<select multiple class="wolmart-scheme-list" data-placeholder="'+s[r].placeholder+'">',c)a+='<option value="'+d+'"'+(l[r]&&l[r].length&&(l[r].indexOf(d)>=0||l[r].indexOf(1*d)>=0)?" selected":"")+">"+c[d]+"</option>";a+="</select>"}a+="</div>"}a+="</div>"}var u=!o.getOptionControls("content_"+t);return this.layoutBoxTemplateReplaced=this.layoutBoxTemplate.replace('class="layout-part content" data-part="content"','class="layout-part content'+(u?" disabled":"")+'" data-part="content_'+t+'"'),"archive_product"!=t&&(this.layoutBoxTemplateReplaced=this.layoutBoxTemplateReplaced.replace('class="layout-part top-sidebar sidebar"','class="layout-part top-sidebar sidebar disabled"')),'<div class="wolmart-layout-item wolmart-layout-item-'+t+'" data-category="'+t+'" data-condition-no="'+e+'"><div class="wolmart-condition"><span class="wolmart-condition-edit-back fa fa-arrow-left"></span><span class="wolmart-condition-title" contenteditable="true">'+(i.title?i.title:o.getConditionTitle(t,!0))+"</span>"+(o.canExtendCondition(t)?this.buttonDuplicate+this.buttonSet:"")+("site"==t?"":this.buttonDelete)+'</div><div class="wolmart-condition-layout">'+this.layoutBoxTemplateReplaced+'<div class="wolmart-layout-options"><div></div></div>'+a+"</div></div>"}},addCondition:function(){var e=t(".wolmart-condition-cat.active").data("category")||"site",i=t(this.getNewConditionUI(e));o.canExtendCondition(e)||t('.wolmart-layout-more-wrap[data-category="'+e+'"]').remove(),t("#wolmart_layout_content").append(i).isotope("appended",i),this.refreshUI("add")},duplicateCondition:function(e){var i,a=t(e.currentTarget),n=(i=a.is(".wolmart-condition-menu > a")?a.parent().data("item"):a.closest(".wolmart-layout-item")).data("category"),s=o.duplicateCondition(n,i.data("condition-no")),l=t(this.getNewConditionUI(n,s));t("#wolmart_layout_content").append(l).isotope("appended",l).isotope("updateSortData"),this.refreshUI("add")},deleteCondition:function(e){if(confirm(wolmart_layout_vars.text_confirm_delete_condition)){var i,a=t(e.currentTarget),n=(i=a.is(".wolmart-condition-menu > a")?a.parent().data("item"):a.closest(".wolmart-layout-item")).data("category");if("site"!=n){if(o.deleteCondition(n,i.data("condition-no")),i.remove(),!o.canExtendCondition(n)){var s=t(this.getAddMoreUI(n));t("#wolmart_layout_content").append(s).isotope("appended",s)}this.refreshUI("layout")}}},changeConditionScheme:function(e){var i=t(e.currentTarget),a=i.closest(".wolmart-scheme-options>div"),n=a.data("scheme"),s=a.closest(".wolmart-layout-item"),l=s.data("category"),r=s.data("condition-no"),c=i.is(":checked");a.toggleClass("disabled",!c),o.setConditionScheme(l,r,n,c)},changeConditionItem:function(e){var i=t(e.currentTarget),a=i.closest(".wolmart-scheme-options>div"),n=a.closest(".wolmart-layout-item"),s=n.data("category"),l=n.data("condition-no"),r=a.data("scheme"),c=i.val();o.canExtendCondition(s,r)&&"object"==typeof c&&o.setConditionScheme(s,l,r,!!c.length&&c)},changeConditionTitle:function(e){var i=t(e.currentTarget),a=i.closest(".wolmart-layout-item"),n=a.data("category"),s=a.data("condition-no");o.setConditionTitle(n,s,i.text())},editPart:function(e){var i=t(e.currentTarget);if(!i.hasClass("disabled")){var a=i.data("part"),n=i.closest(".wolmart-layout").next(".wolmart-layout-options").children(),s="",l=i.closest(".wolmart-layout-item"),r=l.data("category"),c=l.data("condition-no"),d=o.getOptionControls(a),u=o.getOptionValues(r,c);if(d){var m=[];for(var h in d){var p;do{p=Math.floor(65535*Math.random())}while(m.indexOf(p)>=0);m.push(p);var y="_wolmart_"+a+"_"+h+p,f=d[h],v="",w=u&&void 0!==u[h]?u[h]:"";if(f.description?v+='<div class="wolmart-layout-desc"><label>'+f.label+"</label><p>"+f.description+"</p></div>":v+='<label for="'+y+'" class="wolmart-layout-desc">'+f.label+"</label>","buttonset"==f.type){var g="";for(var g in v+='<input type="radio" id="'+y+"_"+g+'" name="'+y+'" value=""'+(""==w?" checked":"")+' class="radio-default">',v+='<label for="'+y+"_"+g+'" class="label-default fas fa-redo"'+(w?"":' checked="true"')+"></label>",v+='<div class="wolmart-radio-button-set">',f.options)v+='<input type="radio" id="'+y+"_"+g+'" name="'+y+'" value="'+g+'"'+(g==w?" checked":"")+">",v+='<label for="'+y+"_"+g+'" class="wolmart_'+a+"_"+h+"_"+g+'">'+f.options[g]+"</label>";v+="</div>"}else if("image"==f.type){g="";for(var g in v+='<input type="radio" id="'+y+"_"+g+'" name="'+y+'" value=""'+(""==w?" checked":"")+' class="radio-default">',v+='<label for="'+y+"_"+g+'" class="label-default fas fa-redo"'+(w?"":' checked="true"')+"></label>",v+='<div class="wolmart-radio-image-set">',f.options)v+='<input type="radio" id="'+y+"_"+g+'" name="'+y+'" value="'+g+'"'+(g==w?" checked":"")+">",v+='<label for="'+y+"_"+g+'" class="wolmart_'+a+"_"+h+"_"+g+'">',v+='<img src="'+wolmart_layout_vars.layout_images_url+f.options[g].image+'" title="'+f.options[g].title+'">',v+="</label>";v+="</div>"}else if(f.type.startsWith("block")){var _=o.getTemplates(f.type.replace("block_",""));for(var b in v+='<div class="wolmart-block-select'+(w&&"hide"!=w?"":" inactive-my")+'">',v+='<div class="wolmart-radio-button-set">',v+='<input type="radio" name="'+y+'" id="'+y+'_" value=""'+(w?"":" checked")+">",v+='<label class="fa fa-redo" for="'+y+'_" title="'+wolmart_layout_vars.text_default+'"></label>',v+='<input type="radio" name="'+y+'" id="'+y+'_hide" value="hide"'+("hide"==w?" checked":"")+">",v+='<label class="fa fa-eye-slash"for="'+y+'_hide"  title="'+wolmart_layout_vars.text_hide+'"></label>',v+='<input type="radio" name="'+y+'" id="'+y+'_my" value="my"'+(w&&"hide"!=w?" checked":"")+">",v+='<label class="far fa-hdd" for="'+y+'_my" title="'+wolmart_layout_vars.text_my_templates+'"></label>',v+="</div>",v+='<select class="wolmart-layout-part-select wolmart-layout-part-control" id="'+y+'" name="'+y+'">',_)v+='<option value="'+b+'"'+(w==b?" selected":"")+">"+_[b]+"</option>";v+="</select>",v+="</div>"}else if("number"==f.type){if(w){var C=w;void 0!==f.min&&(C=Math.max(f.min,C)),void 0!==f.max&&(C=Math.min(f.max,C)),w!=C&&o.setConditionOption(r,c,h,C)}v+='<input type="number" class="wolmart-layout-part-control" name="'+y+'" id="'+y+'"'+(void 0===f.min?"":' min="'+f.min+'"')+(void 0===f.max?"":' max="'+f.max+'"')+' step="1" value="'+w+'">'}else if("select"==f.type){for(var g in v+='<select class="wolmart-layout-part-select wolmart-layout-part-control" id="'+y+'" name="'+y+'">',f.options)v+='<option value="'+g+'"'+(g==w?" selected":"")+">"+f.options[g]+"</option>";v+="</select>"}else if("text"==f.type)v+='<input type="text" name="'+y+'" class="wolmart-layout-part-input wolmart-layout-part-control" id="'+y+'" value="'+w+'"></input>';else if("toggle"==f.type)v+='<div class="wolmart-radio-button-set">',v+='<input type="radio" name="'+y+'" id="'+y+'_" value=""'+(w?"":" checked")+">",v+='<label class="fa fa-redo" for="'+y+'_" title="'+wolmart_layout_vars.text_default+'"></label>',v+='<input type="radio" name="'+y+'" id="'+y+'_no" value="no"'+("no"==w?" checked":"")+">",v+='<label class="fa fa-eye-slash" for="'+y+'_no"></label>',v+='<input type="radio" name="'+y+'" id="'+y+'_yes" value="yes"'+("yes"==w?" checked":"")+">",v+='<label class="fa fa-check"for="'+y+'_yes"></label>',v+="</div>";else if("multicheck"==f.type){if(v+="<ul>",f.options)for(var g in f.options)v+='<li><label><input type="checkbox" name="'+y+'[]" value="'+g+'">'+f.options[g]+"</label></li>";v+="</ul>"}var x=!0;"single_product_template"!=h||u&&"builder"==u.single_product_type||(x=!1),s+='<div class="wolmart-layout-control" '+(x?"":' style="display:none"')+'data-option="'+h+'">'+v+"</div>"}}n.html(s),l.addClass("edit")}},editCondition:function(o){var e,i=t(o.currentTarget);(e=i.is(".wolmart-condition-menu > a")?i.parent().data("item"):i.closest(".wolmart-layout-item")).hasClass("edit-condition")?setTimeout((function(){e.find(".wolmart-scheme-list").each((function(){var o=t(this);o.data("select2")&&o.select2("destroy")}))}),300):e.find(".wolmart-scheme-list:not(.select2-hidden-accessible)").each((function(){var o=t(this);o.select2({placeholder:o.attr("data-placeholder")})})),e.toggleClass("edit-condition")},clickOther:function(o){var e=t(o.target);e.closest(".select2-container").length||e.closest(".wolmart-layout-item").length||!e.is("body *")||(t(".wolmart-layout-item.edit").removeClass("edit"),t(".wolmart-layout-item.edit-condition").removeClass("edit-condition"),setTimeout((function(){t(".wolmart-layout-item .wolmart-scheme-list").each((function(){var o=t(this);o.data("select2")&&o.select2("destroy")}))}),300)),this.closeContextMenu()},goBackFromEdit:function(o){var e=t(o.currentTarget).parent(".wolmart-scheme-options");e.length?(e.hide(),setTimeout((function(){e.show()}),100)):t(o.currentTarget).closest(".wolmart-layout-item").removeClass("edit edit-condition")},changeBlockMode:function(e){var i=e.currentTarget,a=t(i),n=a.closest(".wolmart-layout-item");a.closest(".wolmart-block-select").toggleClass("inactive-my","my"!=i.value),i.name.startsWith("_wolmart_")&&o.setConditionOption(n.data("category"),n.data("condition-no"),a.closest(".wolmart-layout-control").data("option"),i.value),this.refreshLayoutStatus(n)},changeOptionInput:function(e){var i=t(e.currentTarget),a=i.val(),n=i.closest(".wolmart-block-select"),s=e.currentTarget.name;if(n.length&&"my"==e.currentTarget.value&&(a=n.find("select").val()),s.startsWith("_wolmart_")&&(o.setConditionOption(i.closest(".wolmart-layout-item").data("category"),i.closest(".wolmart-layout-item").data("condition-no"),i.closest(".wolmart-layout-control").data("option"),a),s.indexOf("single_product_type")>=0)){var l=i.closest(".wolmart-layout-options").find('.wolmart-layout-control[data-option="single_product_template"]');l.length&&l.toggle("builder"==a)}this.refreshLayoutStatus(t(e.currentTarget).closest(".wolmart-layout-item"))}},i={init:function(){t("#wolmart_layout_content").length&&"undefined"!=typeof wolmart_layout_vars&&(this.model.init(),this.view.init())},view:e,model:o};WolmartAdmin.LayoutBuilder=i,t(document).ready((function(){i.init()}))}(jQuery);